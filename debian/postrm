#!/bin/sh -e

CONFIGFILE="/etc/alternc/local.sh"
MENUFILE="/etc/alternc/menulist.txt"

# Remove mailman aliases to the apache configuration file given as argument
function unconfigure {
    if grep -Eqs "\*\*\*MAILMAN\*\*\*" $1; then
	cp -a -f $1 $1.alternc_mailman
	cat $1 | grep -v "\*\*\*MAILMAN\*\*\*" |
	    grep -v "	Alias /marchives/ /var/lib/mailman/archives/public/" |
	    grep -v "Alias /mimages/ /usr/share/images/mailman/" \
	    > $1.alternc_mailman
	mv -f $1.alternc_mailman $1 
    fi
}

case "$1" in
  remove)
    # Remove Mailman references from Apache configuration
    unconfigure /etc/alternc/templates/apache/httpd.conf
    unconfigure /etc/alternc/templates/apache-ssl/httpd.conf
    alternc.install

    rm -f /var/alternc/cgi-bin/mailman

    if grep -qs "menu_mailman.php" $MENUFILE; then
	rm -f $MENUFILE.alternc_mailman
	cat $MENUFILE | grep -v "menu_mailman.php" >$MENUFILE.alternc_mailman
        mv -f $MENUFILE.alternc_mailman $MENUFILE
    fi
    ;;
  purge)
    if [ -e "$CONFIGFILE" -a -x "/usr/bin/mysql" ]; then
        . "$CONFIGFILE"
        mysql -f -u"$MYSQL_USER" -p"$MYSQL_PASS" -h"$MYSQL_HOST" \
              "$MYSQL_DATABASE" -e "DROP TABLE IF EXISTS mailman"
    fi
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.
#DEBHELPER#
